---
title: "Unit_Testing"
author: "Patrick Krim"
date: "April 12, 2018"
output: html_document
---
```{r, cache=TRUE}
#El Nino years bringing in api for years 1982-1997-2015
#1982-83 CA, variables1
#pcpn data
library(httr)
CA.url <- 'http://data.rcc-acis.org/MultiStnData?params=%7B%22state%22%3A%22ca%22%2C%22sdate%22%3A%221982-01-01%22%2C%22edate%22%3A%221983-01-01%22%2C%22elems%22%3A%22pcpn%22%2C%22meta%22%3A%22ll%22%7D'
test1 <- httr::GET(url=CA.url)
dat <- httr::content(test1, "text","application/json", encoding="UTF-8")
json_data <- jsonlite::fromJSON(dat)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
sdate <- as.Date("1982-01-01")
edate <- as.Date("1983-01-01")
FN1 <- paste0("rds/","_",sdate,".rds")
saveRDS(json_data, file= FN1)
eet <- sapply(json_data$data$data, cbind)
eet[eet=="M"] <- NA
trace <- runif(1000,0.0001,.0099)
eet[eet=="T"] <- sample(trace,replace = T, size = 1)
class(eet) <- "numeric"
dates <- seq.Date(from=lubridate::ymd(sdate), to=lubridate::ymd(edate), by = "1 days")
year <- as.factor(lubridate::year(dates))

#1997-98 CA2, variables2
#pcpn data
CA2.url <- 'http://data.rcc-acis.org/MultiStnData?params=%7B%22state%22%3A%22ca%22%2C%22sdate%22%3A%221997-01-01%22%2C%22edate%22%3A%221998-01-01%22%2C%22elems%22%3A%22pcpn%22%2C%22meta%22%3A%22ll%22%7D'
test2 <- httr::GET(url=CA2.url)
dat2 <- httr::content(test2, "text","application/json", encoding="UTF-8")
json_data2 <- jsonlite::fromJSON(dat2)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
sdate2 <- as.Date("1997-01-01")
edate2 <- as.Date("1998-01-01")
FN2 <- paste0("rds/","_",sdate,".rds")
saveRDS(json_data2, file= FN2)
ens <- sapply(json_data2$data$data, cbind)
ens[ens=="M"] <- NA
trace <- runif(1000,0.0001,.0099)
ens[ens=="T"] <- sample(trace,replace = T, size = 1)
class(ens) <- "numeric"
dates <- seq.Date(from=lubridate::ymd(sdate), to=lubridate::ymd(edate), by = "1 days")
year <- as.factor(lubridate::year(dates))

#2015-16 CA3, variables3
#Pcpn data
CA3.url<- 'http://data.rcc-acis.org/MultiStnData?params=%7B%22state%22%3A%22ca%22%2C%22sdate%22%3A%222015-01-01%22%2C%22edate%22%3A%222016-01-01%22%2C%22elems%22%3A%22pcpn%22%2C%22meta%22%3A%22ll%22%7D'
test3 <- httr::GET(url=CA3.url)
dat3 <- httr::content(test3, "text","application/json", encoding="UTF-8")
json_data3 <- jsonlite::fromJSON(dat3)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
sdate3 <- as.Date("2015-01-01")
edate3 <- as.Date("2016-01-01")
FN3 <- paste0("rds/","_",sdate,".rds")
saveRDS(json_data3, file= FN3)
eft <- sapply(json_data3$data$data, cbind)
eft[eft=="M"] <- NA
trace <- runif(1000,0.0001,.0099)
eft[eft=="T"] <- sample(trace,replace = T, size = 1)
class(eft) <- "numeric"
dates <- seq.Date(from=lubridate::ymd(sdate), to=lubridate::ymd(edate), by = "1 days")
year <- as.factor(lubridate::year(dates))

#Next three are non El Nino 4-6
CA4.url<- 'http://data.rcc-acis.org/MultiStnData?params=%7B%22state%22%3A%22ca%22%2C%22sdate%22%3A%221983-01-01%22%2C%22edate%22%3A%221984-01-01%22%2C%22elems%22%3A%22pcpn%22%7D'
test4 <- httr::GET(url=CA4.url)
dat4 <- httr::content(test4, "text","application/json", encoding="UTF-8")
json_data4 <- jsonlite::fromJSON(dat4)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
sdate4 <- as.Date("1983-01-01")
edate4 <- as.Date("1984-01-01")
FN4 <- paste0("rds/","_",sdate,".rds")
saveRDS(json_data4, file= FN4)
net <- sapply(json_data4$data$data, cbind)
net[ns=="M"] <- NA
trace <- runif(1000,0.0001,.0099)
net[ft=="T"] <- sample(trace,replace = T, size = 1)
class(net) <- "numeric"
dates <- seq.Date(from=lubridate::ymd(sdate), to=lubridate::ymd(edate), by = "1 days")
year <- as.factor(lubridate::year(dates))

CA5.url <- 'http://data.rcc-acis.org/MultiStnData?params=%7B%22state%22%3A%22ca%22%2C%22sdate%22%3A%221998-01-01%22%2C%22edate%22%3A%221999-01-01%22%2C%22elems%22%3A%22pcpn%22%7D'
test5 <- httr::GET(url=CA5.url)
dat5 <- httr::content(test5, "text","application/json", encoding="UTF-8")
json_data5 <- jsonlite::fromJSON(dat5)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
sdate5 <- as.Date("1998-01-01")
edate5 <- as.Date("1999-01-01")
FN5 <- paste0("rds/","_",sdate,".rds")
saveRDS(json_data5, file= FN5)
nne <- sapply(json_data5$data$data, cbind)
nne[ns=="M"] <- NA
trace <- runif(1000,0.0001,.0099)
nne[ft=="T"] <- sample(trace,replace = T, size = 1)
class(nne) <- "numeric"
dates <- seq.Date(from=lubridate::ymd(sdate), to=lubridate::ymd(edate), by = "1 days")
year <- as.factor(lubridate::year(dates))

CA6.url<- 'http://data.rcc-acis.org/MultiStnData?params=%7B%22state%22%3A%22ca%22%2C%22sdate%22%3A%222016-01-01%22%2C%22edate%22%3A%222017-01-01%22%2C%22elems%22%3A%22pcpn%22%7D'
test6 <- httr::GET(url=CA6.url)
dat6 <- httr::content(test6, "text","application/json", encoding="UTF-8")
json_data6 <- jsonlite::fromJSON(dat6)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
sdate6 <- as.Date("2016-01-01")
edate6 <- as.Date("2017-01-01")
FN6 <- paste0("rds/","_",sdate,".rds")
saveRDS(json_data6, file= FN5)
nst <- sapply(json_data6$data$data, cbind)
nst[ns=="M"] <- NA
trace <- runif(1000,0.0001,.0099)
nst[ft=="T"] <- sample(trace,replace = T, size = 1)
class(nst) <- "numeric"
dates <- seq.Date(from=lubridate::ymd(sdate), to=lubridate::ymd(edate), by = "1 days")
year <- as.factor(lubridate::year(dates))



#Location of stations
ll.url <- 'http://data.rcc-acis.org/StnMeta?params=%7B%22state%22%3A%22ca%22%2C%22meta%22%3A%22ll%22%2C%22sdate%22%3A%221982-01-01%22%2C%22edate%22%3A%222015-01-01%22%7D'
test4 <- httr::GET(url=ll.url)
dat4 <- httr::content(test4, "text","application/json", encoding = "UTF-8")
json_data4 <- jsonlite::fromJSON(dat4)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
saveRDS(json_data4, file = FN4)
ll <- sapply(json_data4$meta$ll, cbind)
class(ll) <- "numeric"


#trying to get both lat and long with precipitation
#1982-3
both.url <- 'http://data.rcc-acis.org/MultiStnData?params=%7B%22state%22%3A%22ca%22%2C%22sdate%22%3A%221982-01-01%22%2C%22edate%22%3A%221983-01-01%22%2C%22elems%22%3A%22pcpn%22%2C%22meta%22%3A%22ll%22%7D'
both <- httr::GET(url=CA.url)
dd <- httr::content(both, "text","application/json", encoding="UTF-8")
json_data0 <- jsonlite::fromJSON(dd)
ifelse(dir.exists("rds"), "dir already exists", dir.create("rds"))
sdate <- as.Date("1982-01-01")
edate <- as.Date("1983-01-01")
FN1 <- paste0("rds/","_",sdate,".rds")
saveRDS(json_data0, file= FN1)
eet <- sapply(json_data0$data$data, cbind)
eet[eet=="M"] <- NA
trace <- runif(1000,0.0001,.0099)
eet[eet=="T"] <- sample(trace,replace = T, size = 1)
names(eet) <- c("location",paste(json_data$data$data,json_data$data$meta$ll, sep="_"))
#put in col names as ll
class(eet) <- "numeric"
dates <- seq.Date(from=lubridate::ymd(sdate), to=lubridate::ymd(edate), by = "1 days")
year <- as.factor(lubridate::year(dates))
 eet <- data.frame(date=dates,eet)
  names(eet) <- paste("location",json_data$data$meta$ll, sep="_")


```

Unit testing
Have precipitation data from years of 1982-3, 1997-8, 2015-6 for CA
	Years of intense El Nino
	Have latitude and longitude for each station
Get apiâ€™s for years of 1983-4, 1998-9, 2016-7 for CA
	Years immediately following El Nino
What do I want: What is the precipitation like after an intense El Nino year?
I want the sum for each location 
Function (sum)
Average precipitation (all areas) for each year
Aggregate function (average)
Sum for each location for non-El Nino years 
Same function from El Nino years
Average precipitation (all areas) for each year
Same aggregate function from El Nino years
Create a table that shows the average for each year 
El Nino compared to non-El Nino
Kable function











